swagger: '2.0'
info:
  version: '1.0.0'
  title: CARMIN a Common web API for Remote pipeline INvocation
  description: FLI/IAM REST API for exchanging data and remote calling pipelines.
    
  #termsOfService: http://helloreverb.com/terms/
  #contact:
    #name: Swagger API team
    #email: foo@example.com
    #url: http://swagger.io
  #license:
    #name: MIT
    #url: http://opensource.org/licenses/MIT
#host: petstore.swagger.io
#basePath: /api
security: 
  - {basicAuth:[]}
  - {apiKey:[]}
schemes:
  - http
  - https
consumes:
  - application/json
produces:
  - application/json

securityDefinitions:
  basicAuth:
    type: basic
    description: If supported by the platfrom, it is possible to use HTTP
      Basic Authentication but one must call `/login_basic_http` before 
      calling any API service.
  apiKey:
      # TODO: Should we replace cookie authentication (not supported by Swagger)
      # by apiKey authentication ?
      type: apiKey
      name: api_key
      in: header
      description: If HTTP Basic authentication is not supported, calling
        `/login` allows for password checking and coockie based authentication.
paths:
  /login:
    get:
      description: |
        Check username and password and allow access to the API in case of 
        success by setting a cookie that must be used in any subsequent API
        calls.
      operationId: authenticateSession
      parameters:
        - name: username
          in: query
          description: Name of the user account.
          required: true
          type: string
          format: utf8
        - name: password
          in: query
          description: Password to verify.
          required: true
          type: string
          format: password
      responses:
        '200':
          description: Returns `success` if login is succesful or `failure`
            if login and/or password is incorrect.
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
  /platform:
    get:
      description: Returns information about the platform
      operationId: getPlatformProperties
      produces:
        - application/json
      responses:
        '200':
          description: succesful response
          schema:
            $ref: '#/definitions/platformProperties'
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
  /executions:
    get:
      description: list all execution Ids in the platform
      operationId: getExecutions
      produces:
        - application/json
      responses:
        '200':
          description: successful response
          schema:
            $ref: '#/definitions/executionIds'
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
  /studies/{study}/executions:
    get:
      description: list all execution Ids in the study called {study}
      operationId: getStudyExecutions
      parameters:
        - name: study
          in: path
          description: study name
          required: true
          type: string
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        '200':
          description: successful response
          schema:
            $ref: '#/definitions/executionIds'
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
    post:
      description: |
        initialize a new execution. All necessary data must have already been
        transferred to the platform. The execution may not start immediately 
        (according to a parameter). The user gets the role {execution}_owner.
      operationId: postStudyExecutions
      parameters:
        - name: study
          in: path
          description: study name
          required: true
          type: string
        - name: body
          in: body
          description: |
            An array of key value pairs. The definition is defined as below
          required: true
          schema:
            # it is defined by the pipeline definition.
            # The name denotes the name of parameter in pipeline
            # and the value denotes the value of parameter.
            $ref: '#/definitions/newExecution'
      produces:
        - application/json
      responses:
        '200':
          description: successful response
          schema:
            $ref: '#/definitions/executionId'
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
  /studies/{study}/executions/{execution}:
    get:
      description: get information about an execution
      operationId: getStudyExecutionsExecution
      parameters:
        - name: study
          in: path
          description: study name
          required: true
          type: string
        - name: execution
          in: path
          description: execution id
          required: true
          type: string
      produces:
        - application/json
      responses:
        '200':
          description: successful response
          schema:
            $ref: '#/definitions/execution'
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
    put:
      description: |
        Modify some parameters (i.e. name, timeout) and/or the status of an
        execution (i.e. perform an action of starting or killing an execution).
      operationId: putStudyExecutionsExecution
      consumes:
        - application/json
      parameters:
        - name: study
          in: path
          description: study name
          required: true
          type: string
        - name: execution
          in: path
          description: execution id
          required: true
          type: string
        - name: body
          in: body
          description: to modify a parameter
          required: true
          schema:
            $ref: '#/definitions/keyValuePair'
      responses:
        '200':
          description: successful response
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
    delete:
      description: |
        Delete an execution. This will kill the underlying processes (if possible)
        and free all resources associated with this execution.
      operationId: deleteStudyExecutionsExecution
      parameters:
        - name: study
          in: path
          description: study name
          required: true
          type: string
        - name: execution
          in: path
          description: execution id
          required: true
          type: string
      responses:
        '200':
          description: successful response
        default:
          description: unexpected error
          schema:
            $ref: '#/definitions/errorCodesAndMessage'
definitions:
  platformProperties:
    type: object
    required:
      - platformName
      - supportedTransferProtocols
      - supportedModules
      - defaultLimitListExecutions
      - unsupportedMethods
      - supportedAPIVersion
    properties:
      platformName:
        type: string
        description: Name of the platform.
      APIErrorCodesAndMessages:
        type: array
        items:
          $ref: '#/definitions/errorCodesAndMessage'
      supportedTransferProtocols:
        type: array
        items:
          type: string
        description: Used in getExecutionResults and getAccessURL. Protocol names must be URL prefixes (e.g. “http”, “https”, “ftp”, “sftp”, “ftps”, “scp”, “webdav”). 
      supportedModules:
        type: array
        items:
          type: string # TODO: How to define an enum in Swagger ?
      defaultLimitListExecutions:
        type: integer
        format: int64
        description: The number of Executions returned by Execution.listExecution when limit is not specified.
      email:
        type: string
        format: utf8 # TODO: I do not know if utf8 is valid here.
      platformDescription:
        type: string
        format: utf8
      minAuthorizedExecutionTimeout:
        type: integer
        format: int64
      maxAuthorizedExecutionTimeout:
        type: integer
        format: int64
        description: 0 or absent means no max timeout. max has to be greater or equal to the min.
      defaultExecutionTimeout:
        type: integer
        format: int64
      unsupportedMethods:
        type: array
        items:
          type: string
        description: List of optional methods that are not supported by the platform.
      maxSizeDirectTransfer:
        type: integer
        format: int64
        description: The maximal size of files and directories that can be transferred by methods Path.uploadPath and Path.downloadPath.
      defaultStudy:
        type: string
      supportedAPIVersion:
        type: string
  errorCodesAndMessage:
    type: object
    required:
      - code
      - message
    properties:
      code:
        type: integer
        format: int32
      message:
        type: string
  execution:
    type: object
    required:
      - pipelineIdentifer
      - status
    properties:
      name:
        type: string
        description: execution name
      pipelineIdentifer:
        type: string
        description: which pipeline that started this execution
      status:
        type: string
        "enum": ["initializing",
          "ready",
          "running",
          "finished",
          "initialization_failed",
          "execution_failed",
          "unknown",
          "killed"]
  newExecution:
    type: object
    required:
      - name
      - pipelineIdentifer
      - inputValues
    properties:
      name:
        type: string
        description: name to display to users
      pipelineIdentifer:
        type: string
      timeout:
        type: integer
        description: timeout in seconds
      inputValues:
        type: array
        items:
          $ref: '#/definitions/keyValuePair'
  executionId:
    type: string
  executionIds:
    type: array
    items:
      type: string
  keyValuePair:
    type: object
    required:
      - key
      - value
    properties:
      key:
        type: string
        description: the key value
      value: ## type is ignored here since it could be any type, such as integer, string, list, etc.
        description: the value associated with key
